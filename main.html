<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
			<title>D3 Page Template</title>
			<script type="text/javascript" src="scripts\d3.js"></script>
			<script type="text/javascript" src="scripts\read-csv.js"></script>
			<link rel="stylesheet" type="text/css" href="styles\semantic.css" />
			<!--<link rel="stylesheet" href="style.css">-->
			<style type="text/css">
				/*style of class axis*/	
				body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
				svg{
					display: block;
				}
				.screen{
					position:fixed;
					display: flex;
					align-items: center;
					width:100%;
					height:100%
				}
				.foil{
					position: fixed;
					z-index: 99999;
					top:0;
					left: 0;
					width: 100%;
					height: 100%;
					padding: 0;
					margin: 0;
				}
				.searchBar{
					position: fixed;
					/*max-width: 200px;*/
					/*border: 1px solid white;*/
					top: 0;
					right: 0;
				}
				.searchHints{
					position: fixed;
					max-height: 400px;
					overflow: auto;
					/*max-width: 200px;*/
					/*border: 1px solid white;*/
					top: 40px;
					right: 0;
				}
				.searchHints::-webkit-scrollbar { 
					display: none; 
				}
				.testButton{
					position: fixed;
					top: 0;
					right: 500px;
				}
				.checkboxmenu{
					font-size: 13px;
					position: fixed;
    				left: 0;
					width: 250px; 
					height:100%;
					background-color: rgba(163, 163, 163, 0.795);
				}
				.checkboxmenubuttons{
					position: relative;
					top: 50px;
					margin-left: 10px;
				}
				.catBox{
					/*Checkboxes*/
				}
				.colorBox{
					display: inline-block;
					border: 1px solid black;
					width: 12px;
					height: 12px;
				}
				input[type=text] {
					width: 130px;
					height: 40px;
					box-sizing: border-box;
					border: 1px solid #cccccc6b;
					border-radius: 4px;
					font-size: 16px;
					color: white;
					background-color: rgba(180, 180, 180, 0);
					background-image: url('images/searchicon.png');
					background-size: 21px 21px;
					background-position: 10px; 
					background-repeat: no-repeat;
					padding: 12px 20px 12px 40px;
					-webkit-transition: width 0.4s ease-in-out;
					transition: width 0.4s ease-out;
    				animation: blinker 1s cubic-bezier(0.4, 0, 1, 1) infinite;
				}
				input[type=text]:focus {
					width: 200px;
					animation: none;
				}
				@keyframes blinker {
					50% {
						border: 1px solid rgba(180, 180, 180, 0.24);
					}
				}
				.hint{
					position: relative;
					min-width: 200px;
					height: 40px;
					box-sizing: border-box;
					border: 1px solid #cccccc6b;
					border-radius: 0;
					font-size: 14px;
					color: white;
					background-color: rgba(180, 180, 180, 0.4);
					cursor: pointer;
					padding: 12px 20px 12px 40px;
					animation: side 0.5s ease-in-out;
				}
				.hint:hover{
					background-color: rgba(180, 180, 180, 0.5);
				}
				@keyframes side {
					0% {left: 100%;}
					100% {left: 0%;}
				}
				
			</style>
	</head>
	<body onload='test("https://raw.githubusercontent.com/shourikan/Viso/master/data/final.tsv");'>
		<!--
			### Checkbox menu ###
		-->
		<div id="foil" class="foil">
			<div class="ui segment" style="height:100%;width:100%;background-color:rgba(255, 255, 255, 0.05);border:none;">
				<div class="ui active dimmer">
					<div class="ui text loader">Loading</div>
				</div>
				<p>Loading</p>
			</div>
		</div>
		

		<div class="screen">
			<!--<button class="testButton" onclick="addSuggestion(25);">Add</button>-->
			<div class="searchBar">
				<input type="text" name="search" placeholder="Search..." onkeydown="keyPress(this, event);">
			</div>
			<div id="searchHints" class="searchHints">
				
			</div>
			<div class="checkboxmenu">
				<div class="checkboxmenubuttons">
					<div class="colorBox" style="background-color:#FFFFD9"></div><input onchange="filter(this)" class="catBox" type="checkbox" name="cat" id="c4" value="c4"> Cereal Grains and Pasta<br>
					<div class="colorBox" style="background-color:#C7E9B4"></div><input onchange="filter(this)" class="catBox" type="checkbox" name="cat" id="c3" value="c3"> Breakfast Cereals<br>
					<div class="colorBox" style="background-color:#7FCDBB"></div><input onchange="filter(this)" class="catBox" type="checkbox" name="cat" id="c2" value="c2"> Beverages<br>
					<div class="colorBox" style="background-color:#FBF484"></div><input onchange="filter(this)" class="catBox" type="checkbox" name="cat" id="c8" value="c8"> Fruits and Fruit Juices<br><br>

					<div class="colorBox" style="background-color:#1D91C0"></div><input onchange="filter(this)" class="catBox" type="checkbox" name="cat" id="c5" value="c5"> Dairy and Egg Products<br>
					<div class="colorBox" style="background-color:#253494"></div><input onchange="filter(this)" class="catBox" type="checkbox" name="cat" id="c7" value="c7"> Finfish and Shellfish Products<br><br>

					<div class="colorBox" style="background-color:#F4CDA5"></div><input onchange="filter(this)" class="catBox" type="checkbox" name="cat" id="c13" value="c13"> Sausages and Luncheon Meats<br>
					<div class="colorBox" style="background-color:#FEC44F"></div><input onchange="filter(this)" class="catBox" type="checkbox" name="cat" id="c12" value="c12"> Poultry Products<br>
					<div class="colorBox" style="background-color:#CC4C02"></div><input onchange="filter(this)" class="catBox" type="checkbox" name="cat" id="c1" value="c1"> Beef Products<br>
					<div class="colorBox" style="background-color:#993404"></div><input onchange="filter(this)" class="catBox" type="checkbox" name="cat" id="c11" value="c11"> Pork Products<br><br>

					<div class="colorBox" style="background-color:#00BDAA"></div><input onchange="filter(this)" class="catBox" type="checkbox" name="cat" id="c9" value="c9"> Legumes and Legume Product<br>
					<div class="colorBox" style="background-color:#009494"></div><input onchange="filter(this)" class="catBox" type="checkbox" name="cat" id="c15" value="c15"> Spices and Herbs<br>
					<div class="colorBox" style="background-color:#004E2A"></div><input onchange="filter(this)" class="catBox" type="checkbox" name="cat" id="c17" value="c17">  Vegetables and Vegetable Products<br>
					<div class="colorBox" style="background-color:#081D58"></div><input onchange="filter(this)" class="catBox" type="checkbox" name="cat" id="c10" value="c10"> Nut and Seed Products<br><br>

					<div class="colorBox" style="background-color:#F8D7D0"></div><input onchange="filter(this)" class="catBox" type="checkbox" name="cat" id="c16" value="c16"> Sweets<br>
					<div class="colorBox" style="background-color:#9C4368"></div><input onchange="filter(this)" class="catBox" type="checkbox" name="cat" id="c14" value="c14"> Snacks<br>
					<div class="colorBox" style="background-color:#ED5276"></div><input onchange="filter(this)" class="catBox" type="checkbox" name="cat" id="c6" value="c6"> Fast Foods
				</div>
			</div>
		</div>
		
		<!--
			### D3 Script ###
		-->
		<script type="text/javascript">
		var base;
		var w = 1920;
		var h = 1080;
		var T = [];
		var Tsync = true;
		var highlights = [];
		

		function clearSuggestions(){
			d3.select("#searchHints").html("");
		}

		function addSuggestion(id){
			var searchHints = d3.select("#searchHints");
			searchHints.append("div")
					.attr("class", "hint")
					.attr("id", id)
					.attr("onclick", "checkId(this.id);")
				.append("text")
					.text(base[id][4]);
		}

		function loading(s){
			var a = (s) ? "visible" : "hidden";
			document.getElementById("foil").style.visibility = a;
		}

		function preset(content){
			var val = parseInt(content.split("=")[1])-1;
			var presets = [[3, 4, 5, 7, 8, 9, 10, 17],[1, 3, 7, 8, 9, 10, 15, 17],[2, 4, 5, 6, 8, 10, 13, 14, 16],[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 15, 16, 17]];

			for(var i = 0; i<presets[val].length; i++){
				var el = document.getElementById("c"+presets[val][i]);
				el.checked = true;
				//console.log("checking el: "+i);
				filter(el);
			}
		}

		/*function reset(){
			var nodes = d3.selectAll(".catBox").nodes().each(function(d){
				d.
				d.onchange()
			});
		}*/

		function zoomTo(point){
			var t = [2];
			var scale = 337;
			var cx = w/2;
			var cy = h/2;
			t[0] = cx-(point[0]*(scale));
			t[1] = cy-(point[1]*(scale));
			d3.select(".zoomer").transition().duration(10000).attr("transform", "translate("+t[0]+","+t[1]+")scale("+scale+")");
			swapPhase(2);
		}

		function getTransform(){
			var svg = d3.select(".zoomer");
			var raw = svg.attr("transform");
			var center = [w / 2, h / 2];
			raw = (raw == null) ? ["(0, 0)", "(1)"] : raw.match(/\((.*?)\)/g);
			var tf = raw[0].substring(1, raw[0].length-1).split(",");
			var scale = parseFloat(raw[1].substring(1, raw[1].length-1));

			return [tf[0], tf[1], scale];
		}

		function getAim(){
			var tf = getTransform();
			var center = [w / 2, h / 2];

			return [(center[0]-parseFloat(tf[0]))/tf[2], (center[1]-parseFloat(tf[1]))/tf[2], tf[2]];
		}

		function transition(end) {
			var svg = d3.select(".zoomer");
			var center = [w / 2, h / 2];
			var start = getAim();

			var	x = d3.interpolateNumber(start[0], end[0]);
			var	y = d3.interpolateNumber(start[1], end[1]);
			var	k = d3.interpolateNumber(start[2], end[2]);

			svg.transition()
				.delay(250)
				.duration(1000)
				.attrTween("transform", function() { return function(t) { return transform([x(t), y(t), k(t)]); }; });
		  
			function transform(p) {
			  var k = p[2];
			  T = [center[0] - p[0] * k, center[1] - p[1] * k, k];
			  Tsync = false;
			  return "translate(" + (center[0] - p[0] * k) + "," + (center[1] - p[1] * k) + ")scale(" + k + ")";
			}
		  }

		function keyPress(el, e){
			var value = el.value;
			if (e.keyCode == 13) {
				//console.log(value);
				el.value = "";
				el.placeholder = checkName(value);
			}
			else if(e.keyCode == 27){
				console.log('ESC');
				el.value = "";
				clearSuggestions();
			}
			/*else{
				console.log('Other key');
			}*/
		}

		function checkId(id){
			var point = d3.select(".dot").select("[id='"+id+"']");
			//console.log(point);
			if(point){
				if (getAim()[2] != 1){
					//Out
					swapPhase(1);
					transition([getAim()[0], getAim()[1], 1])
					setTimeout(function(){
						//Over
						transition([point.attr("cx"), point.attr("cy"), 1]);
						setTimeout(function(){
							//In
							transition([point.attr("cx"), point.attr("cy"), 337]);
							setTimeout(function(){swapPhase(2);}, 1500);
						}, 1500);
					}, 1500);
				}
				else{
					//Over
					transition([point.attr("cx"), point.attr("cy"), 1]);
					setTimeout(function(){
						//In
						transition([point.attr("cx"), point.attr("cy"), 337]);
						setTimeout(function(){swapPhase(2);}, 1500);
					}, 1500);
				}	
			}
			else
				console.log("Id not found..");

			clearSuggestions();
		}

		function checkName(name){
			clearSuggestions();
			var list = search(name);
			
			if(list.length > 0){
				if(list.length == 1){
					var point = d3.select("[id='"+list[0]+"']");
					//console.log(point.attr("cx"), point.attr("cy"), base[list[0]][4], list[0]);
					zoomTo([point.attr("cx"),point.attr("cy")]);
					return "Found!";
				}
				else{
					//console.log(list);
					list.forEach(function(i){
						addSuggestion(i);
					});
					return "Multiple..";
				}
			}
			else{
				return "Nothing..";
			}
			return "Error";
			
		}

		function search(name){
			var result = [];
			base.forEach(function(el, i) {
				if(el[4].includes(name))
					result.push(i);
			});
			return result;
		}

		function filter(el){
			var visible = (el.checked) ? "" : "none";
			//console.log(el.value);
			d3.select(".dot")
				.selectAll("."+el.value)
				.attr("display", visible);
		}

		function swapPhase(p){
			var d = document.getElementsByClassName("dot")[0];
			var s = document.getElementsByClassName("shape")[0];
			if(p==1){
				d.setAttribute("display", "");
				s.setAttribute("display", "none");
				phase = 1;
			} else if (p == 2){
				d.setAttribute("display", "none");
				s.setAttribute("display", "");
				phase = 2;
			}
		}

		function drawChart(data){

			if (data!=null){

				base = data;

				//Canvas variables
				var scale = [1, 1000];

				//Phase1 variables
				var size = 1;
				var padding = 30;
				phase = 1;

				
				//Phase2 variables
				//Donut
				var itemX = 12;
				var padAngle = 0.05;
				var padRadius = 0;
				//Polygon, Lines
				var t = 0;
				var items = 11;
				var angleProgress = 360/(items+1);
				var path = "";

				//Food Categories
				var categories = ["Beef Products", "Beverages", "Breakfast Cereals", 
				"Cereal Grains and Pasta", "Dairy and Egg Products", "Fast Foods", "Finfish and Shellfish Products", "Fruits and Fruit Juices", "Legumes and Legume Products",
				"Nut and Seed Products", "Pork Products", "Poultry Products", "Sausages and Luncheon Meats", "Snacks", "Spices and Herbs", "Sweets", "Vegetables and Vegetable Products"];

				//Categories Colors
				var colors = ["#CC4C02", "#7FCDBB", "#C7E9B4", 
				"#FFFFD9", "#1D91C0", "#ED5276", "#253494", "#FBF484", "#00BDAA",
				"#081D58", "#993404", "#FEC44F", "#F4CDA5", "#9C4368", "#009494", "#F8D7D0", "#004E2A"];

				//Macro chart data/colors
				var macroNames = ["Protein", "Fat", "Carb"];
				var macroColors = ["rgb(215,223,35)", "rgb(190,30,45)", "rgb(247,148,30)"];

				var zoom = d3.zoom().scaleExtent(scale).on("zoom", zoomF);

				function zoomF(){
					//console.log(Tsync);
					if (!Tsync){
						d3.event.transform.x = T[0];
						d3.event.transform.y = T[1];
						d3.event.transform.k = T[2];
						Tsync = true; 
					}
					else{
						container.attr("transform", d3.event.transform);

						var k = d3.event.transform.k;

						if (k < 40 && phase == 2)
							swapPhase(1);
						else if (k >= 40 && phase == 1)
							swapPhase(2);
					}
				}

				//Create SVG element
				var svg = d3.select(".screen")
					.append("svg")
						.attr("width", "100%")
						.attr("height", "100%")
					.append("g")
						.call(zoom);

				var rect = svg.append("rect")
					.attr("width", w)
					.attr("height", h)
					.style("fill", "black")
					.style("pointer-events", "all");

				var container = svg.append("g")
					.attr("class", "zoomer");

				var dataset = data;
				
				//Solution to negative values could be global shift of values by min value

				var xScale = d3.scaleLinear()
								.domain([d3.min(dataset, function(d) { return d[0]; }), d3.max(dataset, function(d) { return d[0]; })])
								.range([padding, w-padding*2]);
				var yScale = d3.scaleLinear()
								.domain([d3.min(dataset, function(d) { return d[1]; }), d3.max(dataset, function(d) { return d[1]; })])
								.range([h-padding, padding]);

				//Size scale
				var itemSizeScale = d3.scaleLinear()
				.domain([d3.min(dataset, function(d) { return d[5]; }), d3.max(dataset, function(d) { return d[5]; })])
				.range([0, 1]);

				//Shape scales
				var itemScales = [items];
				for (var i = 0; i<items; i++){
					var index = i+9;
					//itemScales[i] = d3.max(dataset, function(d) { return d[index]; });
					itemScales[i] = d3.scaleLinear()
				.domain([0, 2*(d3.mean(dataset, function(d) { return d[index]; })+d3.deviation(dataset, function(d) { return d[index]; }))])
				.range([0, 1]);
					//console.log(itemScales[i]);
				}
						
				//Draw dots
				var dot = container.append("g")
						.attr("class", "dot")
						.attr("display", "");

				var radiusCircle = d3.select(".dot").append("circle")
						.attr("cx", 10)
						.attr("cy",10)
						.attr("r", 10)
						.attr("visibility", "hidden")
						.style("stroke-dasharray", ("2, 0.5"))
						.style("stroke", "rgba(255, 124, 0, 0.6)")
						.style("stroke-width", "0.5")
						.style("fill", "rgba(255, 124, 0, 0.34)");
					
				dot.selectAll("circle")
						.data(dataset)
						.enter()
					.append("circle")
						.attr("cx",function(d) { return xScale(d[0]);})
						.attr("cy",function(d) { return yScale(d[1]);})
						.attr("r", 1)
						.attr("fill", function(d) { return colors[d[3]]; })
						.attr("id", function(d, i) { return i;})
						.attr("class", function(d) { return "c"+d[3]; })
						.attr("display", "none")
						.on("click", function(){

							var el = d3.select(this);
							var x = el.attr("cx");
							var y = el.attr("cy");

							//Show radius
							radiusCircle.attr("cx", x)
							.attr("cy", y)
							.attr("visibility", "visible");

							//Clear highlights
							highlights.forEach(function(i){
								d3.select("[id='"+i+"']")
										.style("stroke", "none");
								highlights = [];
							});

							//Find 3 nodes
							var nodes = d3.select(".dot").selectAll("circle[display='']").each(function(){
								var node = d3.select(this);
								var deltaX = node.attr("cx")-x;
								var deltaY = node.attr("cy")-y;
								var distance = Math.sqrt(Math.pow(deltaX, 2) + Math.pow(deltaY, 2));
								var radius = radiusCircle.attr("r");
								if(highlights.length<3 && radius>=distance && el.attr("id")!=node.attr("id") && el.attr("class")!=node.attr("class")){
									var unique = true;
									highlights.forEach(function(i){
										if(node.attr("class")==d3.select("[id='"+i+"']").attr("class"))
											unique = false;
									});
									if(unique){
										highlights.push(node.attr("id"));
									}
								}
							});

							highlights.forEach(function(i){
								d3.select("[id='"+i+"']")
										.style("stroke", "green")
										.style("stroke-width", "0.3");
							});
							
						})
					.append("svg:title")
						.text(function(d) { return d[4]; });

				function showRadius(el){
					
				}

				var strokeColor = "white";

				//Draw shapes
				shape = container.append("g")
						.attr("class", "shape")
						.attr("display", "none")
					.selectAll("g")
						.data(dataset)
						.enter()
					.append("g")
						.attr('transform', function(d){return "translate("+xScale(d[0])+","+yScale(d[1])+")";})
						.each(function (d) {
							var el = d3.select(this);

							var elSize = itemSizeScale(d[5])*itemX;
							//console.log(elSize);
							
							var donutW = elSize/3;
							var radius = donutW / 2;
							var donutWidth = donutW / 6;

							var arc = d3.arc()
								.innerRadius(radius - donutWidth)
								.outerRadius(radius)
								.cornerRadius(padRadius)
								.padAngle(padAngle);
							
							//Lines
							path = "";
							var innerR = radius;
							var maxR = (elSize/2)-innerR;
							//var finalT = t+innerR;
							for(var i = 0; i < items; i++) {
								
								var index = i+9;
								var cx = 0, cy = 0;
								
								
								var r = ((itemScales[i](d[index]))*maxR)+innerR;
								//var r = d[index]+innerR;
								r = (r>maxR+innerR) ? maxR+innerR : r;
								//console.log(itemScales[i](d[index]), maxR);
								var x = cx + r * Math.cos(2 * Math.PI * i / items);
								var y = cy + r * Math.sin(2 * Math.PI * i / items);
								var innerX = cx + innerR * Math.cos(2 * Math.PI * i / items);
								var innerY = cy + innerR * Math.sin(2 * Math.PI * i / items);

								//console.log(cx, cy, maxR, r, x, y, innerX, innerY);
								//console.log(d[index], itemScales[i], d[index]/itemScales[i]);
								path = path.concat(x+","+y+", "); 
								
								//var widthS = ((elSize/itemX)*0.1);
								var line = el.append("line")
										.attr("x1", innerX)
										.attr("y1", innerY)
										.attr("x2", x)
										.attr("y2", y)
										.attr('stroke-width', 0.01)
										.attr("stroke", strokeColor);
							}

							//Polygon
							path = path.substring(0, path.length-2);
							var polygon = el.append("polygon")
									.attr('stroke-width', 0.01)
									.attr("stroke", strokeColor)
									.attr("fill", "rgb(255,255,255,0.25)")
									.attr("points", path)
								.append("svg:title")
									.text(d[4]);

							//Donut
							var tempData = [d[6], d[7], d[8]]; 
							d3.select(this).selectAll('path')
									.data(d3.pie().sort(null)(tempData))
									.enter()
								.append('path')
									.attr('d', arc)
									.attr('fill', function(d, i){return macroColors[i];})
								.append("svg:title")
									.text(function(d, i){return macroNames[i];});
								
							});

				preset(location.search.substr(1));
				loading(false);
			}
		}

		</script>
	</body>
</html>