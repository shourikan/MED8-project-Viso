<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
			<title>D3 Page Template</title>
			<script type="text/javascript" src="d3.js"></script>
			<!--<link rel="stylesheet" href="style.css">-->
			<style type="text/css">
				/*style of class axis*/	
				body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
				.axis path,
				.axis line {
					fill: none;
					stroke: violet;
					shape-rendering: crispEdges;
				}
				.axis text {
					font-family: sans-serif;
					font-size: 10px;
				}
			</style>
	</head>
	<body>
		<!--
			### CSV Script ###
		-->
		<script type="text/javascript" src="read-csv.js"></script>

		<!--
			### CSV File ###
		-->
		<fieldset id="load">
			<form>
				<label for="csvFileInput"> <strong>CSV File:</strong>
				</label>
				<button type="button" onclick="test('https://raw.githubusercontent.com/shourikan/Viso/master/final.csv')">Load</button>
			</form>
			<br>
			<div id="output" style="max-height:50px;overflow-y:scroll;border:green solid 1px">
			</div>
		</fieldset>
		<!--
			### Chart div ###
		
		<div id="canvas" style="width: 800px; height:400px;"></div>-->
		
		<!--
			### D3 Script ###
		-->
		<script type="text/javascript">

		function swapPhase(p){
			var d = document.getElementsByClassName("dot")[0];
			var s = document.getElementsByClassName("shape")[0];
			if(p==1){
				d.setAttribute("display", "");
				s.setAttribute("display", "none");
				phase = 1;
			} else if (p == 2){
				d.setAttribute("display", "none");
				s.setAttribute("display", "");
				phase = 2;
			}
		}

		function drawChart(data){

			//Turn off loading window
			document.getElementById("load").style.display = "none";

			//Canvas variables
			var w = 1440;
			var h = 960;
			var scale = [1, 1000];

			//Phase1 variables
			var size = 1;
			var padding = 30;
			phase = 1;

			
			//Phase2 variables
			//Donut
			var itemX = 4;
			var padAngle = 0.05;
			var padRadius = 0;
			//Polygon, Lines
			var t = 0;
			var items = 11;
			var angleProgress = 360/(items+1);
			var path = "";

			//Color palette
			var colors = ["white", "#F19CA2", "#EDF8B1", "#CC4C02", "#7FCDBB", "#C7E9B4", 
			"#FFFFD9", "#1D91C0", "#ED5276", "#00585E", "#253494", "#FBF484", "#FF5729", "#00BDAA", "white",
			"#081D58", "#993404", "#FEC44F", "white", "#F4CDA5", "#9C4368", "#A5D3E6", "#009494", "#F8D7D0", "#004E2A"];

			//Macro chart data/colors
			var macroNames = ["Protein", "Fat", "Carb"];
    		var macroColors = ["rgb(215,223,35)", "rgb(247,148,30)", "rgb(190,30,45)"];

			//Create SVG element
			var svg = d3.select("body")
				.append("svg")
					.attr("width", "100%")
					.attr("height", "100%")
				.append("g")
					.call(d3.zoom().scaleExtent(scale).on("zoom", function () {
					container.attr("transform", d3.event.transform);
					var scale = container.attr("transform").match(/\((.*?)\)/g)[1];
					scale = scale.substring(1, scale.length-1);
					//console.log(scale);
					if (parseInt(scale) < 20 && phase == 2)
						swapPhase(1);
					else if (parseInt(scale) >= 20 && phase == 1)
						swapPhase(2);
				}));

			var rect = svg.append("rect")
				.attr("width", w)
				.attr("height", h)
				.style("fill", "none")
				.style("pointer-events", "all");

			var container = svg.append("g");

			//Create donut properties
			
			

			if (data!=null){
				var dataset = data;
				
				//Solution to negative values could be global shift of values by min value

				var xScale = d3.scaleLinear()
								.domain([d3.min(dataset, function(d) { return d[0]; }), d3.max(dataset, function(d) { return d[0]; })])
								.range([padding, w-padding*2]);
				var yScale = d3.scaleLinear()
								.domain([d3.min(dataset, function(d) { return d[1]; }), d3.max(dataset, function(d) { return d[1]; })])
								.range([h-padding, padding]);

				//Size scale
				var itemSizeScale = d3.scaleLinear()
				.domain([d3.min(dataset, function(d) { return d[4]; }), d3.max(dataset, function(d) { return d[4]; })])
				.range([0, 1]);

				//Shape scales
				var itemScales = [items];
				for (var i = 0; i<items; i++){
					var index = i+8;
					//itemScales[i] = d3.max(dataset, function(d) { return d[index]; });
					itemScales[i] = d3.scaleLinear()
				.domain([0, d3.max(dataset, function(d) { return d[index]; })])
				.range([0, 1]);
					//console.log(itemScales[i]);
				}

				/*var rScale = d3.scaleLinear()
								.domain([d3.min(dataset, function(d) { return d[1]; }), d3.max(dataset, function(d) { return d[1]; })])
								.range([size, size]);*/														
				
								
				/*var xAxis = d3.axisBottom()
							.scale(xScale)
							.ticks(9);
							
				var yAxis = d3.axisLeft()
							.scale(yScale)
							.ticks(5);*/
						
				//Draw dots
				dot = container.append("g")
						.attr("class", "dot")
						.attr("display", "")
					.selectAll("circle")
						.data(dataset)
						.enter()
					.append("circle")
						.attr("cx",function(d) { return xScale(d[0]);})
						.attr("cy",function(d) { return yScale(d[1]);})
						.attr("r", 1)
						.attr("fill", function(d) { return colors[d[3]]; })
					.append("svg:title")
						.text(function(d) { return d[2]; });
						
				//Draw shapes
				shape = container.append("g")
						.attr("class", "shape")
						.attr("display", "none")
					.selectAll("g")
						.data(dataset)
						.enter()
					.append("g")
						.attr('transform', function(d){return "translate("+xScale(d[0])+","+yScale(d[1])+")";})
						.each(function (d) {
							var el = d3.select(this);

							var elSize = itemSizeScale(d[4])*itemX;
							//console.log(elSize);
							
							var donutW = elSize/2;
							var radius = donutW / 2;
							var donutWidth = donutW / 6;

							var arc = d3.arc()
								.innerRadius(radius - donutWidth)
								.outerRadius(radius)
								.cornerRadius(padRadius)
								.padAngle(padAngle);
							

							//Donut
							var tempData = [d[5], d[6], d[7]]; 
							d3.select(this).selectAll('path')
									.data(d3.pie().sort(null)(tempData))
									.enter()
								.append('path')
									.attr('d', arc)
									.attr('fill', function(d, i){return macroColors[i];})
								.append("svg:title")
									.text(d[2]);
							
							//Lines
							path = "";
							var innerR = donutW/2;
							//var finalT = t+innerR;
							for(var i = 0; i < items; i++) {
								
								var index = i+8;
								var cx = 0, cy = 0;
								
								var maxR = elSize/2;
								//var r = ((itemScales[i](d[index]))*maxR)+innerR;
								var r = d[index]+innerR;
								r = (r>2) ? 2 : r;
								//console.log(itemScales[i](d[index]), maxR);
								var x = cx + r * Math.cos(2 * Math.PI * i / items);
								var y = cy + r * Math.sin(2 * Math.PI * i / items);
								var innerX = cx + innerR * Math.cos(2 * Math.PI * i / items);
								var innerY = cy + innerR * Math.sin(2 * Math.PI * i / items);

								//console.log(cx, cy, maxR, r, x, y, innerX, innerY);
								//console.log(d[index], itemScales[i], d[index]/itemScales[i]);
								path = path.concat(x+","+y+", "); 
								
								//var widthS = ((elSize/itemX)*0.1);
								var line = el.append("line")
										.attr("x1", innerX)
										.attr("y1", innerY)
										.attr("x2", x)
										.attr("y2", y)
										.attr('stroke-width', 0.01)
										.attr("stroke", "black");
							}
							//Polygon
							path = path.substring(0, path.length-2);
							var polygon = el.append("polygon")
									.attr('stroke-width', 0.01)
									.attr("stroke", "black")
									.attr("fill", "none")
									.attr("points", path)
								.append("svg:title")
									.text(d[2]);
							
						  });
				/*shape = container.append("g")
						.attr("class", "shape")
						.attr("display", "none")
					.selectAll("circle")
						.data(dataset)
						.enter()
					.append("circle")
						.attr("cx",function(d) { return xScale(d[0]);})
						.attr("cy",function(d) { return yScale(d[1]);})
						.attr("r", 1)
						.attr("fill", "black");*/
						
					/* svg.selectAll("text")
					.data(dataset)
					.enter()
					.append("text")
					.text(function(d) {
							return d[0] + "," + d[1];
					})
					.attr("x",function(d) {
							return xScale(d[0]);
					})
					.attr("y",function(d) {
							return yScale(d[1]);
					})
					.attr("font-family", "sans-serif")
					.attr("font-size", "11px")
					.attr("fill", "red"); */
					
									
					/*svg.append("g")
						.attr("class", "axis")
						.attr("transform", "translate("+ (-size) +"," + (h - padding +size) + ")")
						.call(xAxis);
					
					svg.append("g")
						.attr("class", "axis")
						.attr("transform", "translate("+ (padding-size) +","+ (size) +")")
						.call(yAxis);*/
			}
		}

		</script>
	</body>
</html>